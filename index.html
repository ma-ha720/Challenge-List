<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†ã‚¢ãƒ—ãƒª - ã‚ã‚‰ã‚†ã‚‹è¡Œå‹•ã‚’å¯è¦–åŒ–">
  <title>ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒªã‚¹ãƒˆâœ¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #ffeef8 0%, #ffe6f0 50%, #fff0f8 100%);
      min-height: 100vh;
      padding: 15px;
      position: relative;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header {
      background: linear-gradient(135deg, #ff9ed8 0%, #ffb8e6 100%);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(255, 105, 180, 0.3);
      margin-bottom: 15px;
    }

    .header h1 {
      color: white;
      font-size: 26px;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
    }

    .header p {
      color: #fff0f8;
      font-size: 14px;
    }

    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .nav-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .nav-btn-primary {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }

    .nav-btn-secondary {
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
    }

    .nav-btn-tertiary {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .nav-btn:active {
      transform: scale(0.95);
    }

    /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* æº–å‚™ç”»é¢ */
    .setup-screen {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .setup-title {
      font-size: 22px;
      color: #ff69b4;
      margin-bottom: 15px;
      text-align: center;
    }

    .mission-input-container {
      margin-bottom: 20px;
    }

    .mission-input {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .mission-input input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ffb8e6;
      border-radius: 10px;
      font-size: 16px;
    }

    .mission-input input:focus {
      outline: none;
      border-color: #ff69b4;
    }

    .delete-btn {
      padding: 12px 15px;
      background: #f87171;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
    }

    .add-mission-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .start-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(251, 191, 36, 0.4);
    }

    /* ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”»é¢ */
    .challenge-screen {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .progress-section {
      text-align: center;
      margin-bottom: 25px;
    }

    .character-display {
      font-size: 100px;
      margin: 15px 0;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    .progress-text {
      font-size: 24px;
      font-weight: bold;
      color: #ff69b4;
      margin-bottom: 10px;
    }

    .progress-bar-container {
      background: #f0f0f0;
      border-radius: 20px;
      height: 30px;
      overflow: hidden;
      margin-bottom: 15px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }

    .missions-list {
      margin-bottom: 20px;
    }

    .mission-item {
      background: #fff0f8;
      border: 3px solid #ffb8e6;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .mission-item:active {
      transform: scale(0.98);
    }

    .mission-item.completed {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border-color: #22c55e;
    }

    .mission-checkbox {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid #ffb8e6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: white;
      flex-shrink: 0;
    }

    .mission-item.completed .mission-checkbox {
      background: #22c55e;
      border-color: #22c55e;
      color: white;
    }

    .mission-text {
      flex: 1;
      font-size: 18px;
      font-weight: bold;
      color: #ff69b4;
    }

    .mission-item.completed .mission-text {
      color: #166534;
      text-decoration: line-through;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .action-btn {
      flex: 1;
      min-width: 140px;
      padding: 15px;
      border: none;
      border-radius: 15px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .finish-btn {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .stop-btn {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }

    /* å®Œäº†ç”»é¢ */
    .complete-screen {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .complete-character {
      font-size: 120px;
      margin: 20px 0;
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .complete-title {
      font-size: 28px;
      color: #ff69b4;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .complete-message {
      font-size: 18px;
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    /* ã”è¤’ç¾å†™çœŸ */
    .reward-photo-container {
      margin: 20px 0;
      padding: 20px;
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
    }

    .reward-photo-title {
      font-size: 20px;
      font-weight: bold;
      color: #92400e;
      margin-bottom: 15px;
    }

    .reward-photo {
      max-width: 100%;
      max-height: 300px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      animation: photoReveal 1s ease;
    }

    @keyframes photoReveal {
      0% { transform: scale(0) rotate(-10deg); opacity: 0; }
      50% { transform: scale(1.1) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    .result-box {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .result-number {
      font-size: 48px;
      font-weight: bold;
      color: #f59e0b;
      margin: 10px 0;
    }

    .praise-message {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: bold;
      color: #166534;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* å±¥æ­´ç”»é¢ */
    .history-screen {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .history-title {
      font-size: 22px;
      color: #ff69b4;
      margin-bottom: 20px;
      text-align: center;
    }

    .history-item {
      background: #fff0f8;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 12px;
      border-left: 5px solid #ff69b4;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .history-content {
      flex: 1;
    }

    .history-date {
      font-size: 14px;
      color: #999;
      margin-bottom: 5px;
    }

    .history-stats {
      font-size: 18px;
      font-weight: bold;
      color: #ff69b4;
    }

    .delete-history-btn {
      padding: 8px 12px;
      background: #f87171;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      flex-shrink: 0;
      transition: all 0.3s ease;
    }

    .delete-history-btn:hover {
      background: #ef4444;
      transform: scale(1.1);
    }

    .delete-history-btn:active {
      transform: scale(0.95);
    }

    .no-history {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 16px;
    }

    /* å†™çœŸç®¡ç†ç”»é¢ */
    .photo-manager-screen {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .photo-manager-title {
      font-size: 22px;
      color: #ff69b4;
      margin-bottom: 20px;
      text-align: center;
    }

    .photo-upload-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #fff0f8;
      border-radius: 15px;
      border: 2px dashed #ffb8e6;
    }

    .photo-upload-label {
      display: block;
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .photo-upload-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    }

    .photo-upload-input {
      display: none;
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .photo-item:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .photo-delete-btn:hover {
      background: rgba(220, 38, 38, 1);
      transform: scale(1.1);
    }

    .no-photos {
      text-align: center;
      color: #999;
      padding: 40px;
      font-size: 16px;
    }

    /* ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ */
    .power-neko-link {
      display: block;
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      color: white;
      text-decoration: none;
      border-radius: 15px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 600px) {
      .header h1 {
        font-size: 22px;
      }

      .character-display {
        font-size: 80px;
      }

      .complete-character {
        font-size: 100px;
      }

      .nav-buttons {
        flex-wrap: wrap;
      }

      .nav-btn {
        min-width: calc(50% - 5px);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <h1>âœ¨ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒªã‚¹ãƒˆ âœ¨</h1>
      <p>ã©ã‚“ãªã“ã¨ã§ã‚‚ ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—!</p>
    </div>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="nav-buttons">
      <button class="nav-btn nav-btn-primary" onclick="showScreen('setup')">
        ğŸ“ æº–å‚™
      </button>
      <button class="nav-btn nav-btn-secondary" onclick="showScreen('history')">
        ğŸ“Š è¨˜éŒ²
      </button>
      <button class="nav-btn nav-btn-tertiary" onclick="showScreen('photos')">
        ğŸ“¸ å†™çœŸ
      </button>
    </div>

    <!-- æº–å‚™ç”»é¢ -->
    <div class="screen active" id="setupScreen">
      <div class="setup-screen">
        <div class="setup-title">ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
        
        <!-- Geminiãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ -->
        <a href="https://gemini.google.com/gem/1Xxzm7Gr9Ji-Pe_DhTv6mmUQPajlaWw93?usp=sharing" target="_blank" style="display: block; padding: 15px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; text-decoration: none; border-radius: 15px; text-align: center; font-weight: bold; font-size: 16px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); margin-bottom: 15px;">
          ğŸ¤– Geminiã«èã„ã¦ã¿ã‚‹
        </a>
        
        <!-- ã‚³ãƒ”ãƒšç”¨ã‚¨ãƒªã‚¢ -->
        <div style="margin-bottom: 15px;">
          <textarea id="bulkPasteArea" placeholder="Geminiã®å›ç­”ã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #a78bfa; border-radius: 10px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
          <button onclick="parseBulkPaste()" style="width: 100%; padding: 12px; margin-top: 10px; background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
            ğŸ“¥ ä¸€æ‹¬è¿½åŠ 
          </button>
        </div>
        
        <div style="text-align: center; margin: 15px 0; color: #999; font-size: 14px;">
          ã¾ãŸã¯æ‰‹å…¥åŠ› â†“
        </div>
        
        <div class="mission-input-container" id="missionInputs">
          <!-- å‹•çš„ã«è¿½åŠ  -->
        </div>
        <button class="add-mission-btn" onclick="addMissionInput()">
          â• ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¿½åŠ 
        </button>
        <button class="start-btn" onclick="startChallenge()">
          ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆ!
        </button>
      </div>
    </div>

    <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç”»é¢ -->
    <div class="screen" id="challengeScreen">
      <div class="challenge-screen">
        <div class="progress-section">
          <div class="character-display" id="challengeCharacter">ğŸ˜¸</div>
          <div class="progress-text" id="progressText">0 / 0</div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
          </div>
        </div>

        <div class="missions-list" id="missionsList">
          <!-- å‹•çš„ã«è¿½åŠ  -->
        </div>

        <div style="margin-bottom: 15px;">
          <input type="text" id="newMissionInput" placeholder="ã‚ãŸã‚‰ã—ã„ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ ã¤ã„ã‹" style="width: 100%; padding: 12px; border: 2px solid #ffb8e6; border-radius: 10px; font-size: 16px; margin-bottom: 10px;">
          <button class="add-mission-btn" onclick="addMissionDuringChallenge()">
            â• ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ è¿½åŠ 
          </button>
        </div>

        <div class="action-buttons">
          <button class="action-btn finish-btn" onclick="finishChallenge()">
            âœ¨ ã‹ã‚“ã‚Šã‚‡ã†!
          </button>
          <button class="action-btn stop-btn" onclick="stopChallenge()">
            ğŸ  ä»Šæ—¥ã¯ã“ã“ã¾ã§
          </button>
        </div>

        <a href="https://ma-ha720.github.io/power-charge-cat/" style="display: block; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); color: white; text-decoration: none; border-radius: 15px; text-align: center; font-weight: bold; font-size: 16px; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
          ğŸ˜¸ ãƒ‘ãƒ¯ãƒ¼ã˜ã‚…ã†ã§ã‚“ã­ã“ã§ ã‚„ã™ã‚‚ã†!
        </a>
      </div>
    </div>

    <!-- å®Œäº†ç”»é¢ -->
    <div class="screen" id="completeScreen">
      <div class="complete-screen">
        <div class="complete-character">ğŸ‰</div>
        <div class="complete-title" id="completeTitle">ãŠã¤ã‹ã‚Œã•ã¾!</div>
        <div class="complete-message" id="completeMessage"></div>

        <!-- ã”è¤’ç¾å†™çœŸè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="reward-photo-container" id="rewardPhotoContainer" style="display: none;">
          <div class="reward-photo-title">âœ¨ ã™ããªã‚‚ã® âœ¨</div>
          <img id="rewardPhoto" class="reward-photo" alt="ã”è¤’ç¾å†™çœŸ">
        </div>

        <div class="result-box">
          <div>ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</div>
          <div class="result-number" id="resultNumber">0 / 0</div>
        </div>

        <div class="praise-message" id="praiseMessage">
          ã™ã”ã„! ãŒã‚“ã°ã£ãŸã­! âœ¨
        </div>

        <button class="start-btn" onclick="showScreen('setup')">
          ğŸ“ ã¤ãã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¸
        </button>
      </div>
    </div>

    <!-- å±¥æ­´ç”»é¢ -->
    <div class="screen" id="historyScreen">
      <div class="history-screen">
        <div class="history-title">ã“ã‚Œã¾ã§ã®è¨˜éŒ²</div>
        <div id="historyList">
          <!-- å‹•çš„ã«è¿½åŠ  -->
        </div>
      </div>
    </div>

    <!-- å†™çœŸç®¡ç†ç”»é¢ -->
    <div class="screen" id="photosScreen">
      <div class="photo-manager-screen">
        <div class="photo-manager-title">ğŸ“¸ å¥½ããªå†™çœŸ ğŸ“¸</div>
        
        <div class="photo-upload-section">
          <label for="photoUpload" class="photo-upload-label">
            ğŸ“· å†™çœŸã‚’è¿½åŠ ã™ã‚‹
          </label>
          <input 
            type="file" 
            id="photoUpload" 
            class="photo-upload-input" 
            accept="image/*" 
            multiple
            onchange="handlePhotoUpload(event)">
        </div>

        <div style="text-align: center; margin-bottom: 15px; color: #999; font-size: 14px;">
          ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒçµ‚ã‚ã£ãŸã¨ãã«<br>
          ãƒ©ãƒ³ãƒ€ãƒ ã§1æšè¡¨ç¤ºã•ã‚Œã¾ã™ ğŸ‰
        </div>

        <div class="photo-grid" id="photoGrid">
          <!-- å‹•çš„ã«è¿½åŠ  -->
        </div>

        <div id="noPhotos" class="no-photos">
          ã¾ã å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“<br>
          å¥½ããªå†™çœŸã‚’è¿½åŠ ã—ã¦ãã ã•ã„
        </div>
      </div>
    </div>
  </div>

  <script>
    // çŠ¶æ…‹ç®¡ç†
    let missions = [];
    let currentMissions = [];
    let completedCount = 0;
    let history = [];
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
    const STORAGE_KEY_STATE = 'challengeState';
    const STORAGE_KEY_HISTORY = 'challengeHistory';
    const STORAGE_KEY_PHOTOS = 'rewardPhotos';

    // è¤’ã‚è¨€è‘‰ãƒªã‚¹ãƒˆ
    const praiseMessages = [
      'ã™ã”ã„! ã§ããŸã­! âœ¨',
      'ã‚„ã£ãŸãƒ¼! ãŒã‚“ã°ã£ãŸã­! ğŸŒŸ',
      'ã‹ã£ã“ã„ã„! ğŸ’ª',
      'ã‚¹ãƒ†ã‚­! æ¬¡ã‚‚ã§ãã‚‹ã‚ˆ! ğŸ‰',
      'ã‚¯ãƒªã‚¢! ã™ã°ã‚‰ã—ã„! âœ¨',
      'ãŒã‚“ã°ã£ãŸã­! ãˆã‚‰ã„! ğŸŒˆ',
      'ã§ããŸ! ã‚„ã£ãŸã­! ğŸŠ',
      'ã•ã™ãŒ! ã™ã”ã„ã­! â­',
      'ã‚„ã‚‹ã­! æœ€é«˜! ğŸ¯',
      'ã™ã°ã‚‰ã—ã„! ğŸ‘',
      'ã§ãã¡ã‚ƒã£ãŸ! ã™ã”ã„! ğŸ’«',
      'ãŒã‚“ã°ã£ãŸã‚‚ã‚“! ãˆã‚‰ã„! ğŸŒ¸',
      'æˆåŠŸ! ã‚ˆãã‚„ã£ãŸ! ğŸ†',
      'ã‚¹ã‚´ã™ã! ğŸš€',
      'ãŒã‚“ã°ã£ã¦ã‚‹! ã‹ã£ã“ã„ã„! ğŸ’ª',
      'ã‚„ã£ãŸã­! å¤§æˆåŠŸ! ğŸ‰',
      'ã™ã¦ã! ãŒã‚“ã°ã£ãŸã­! âœ¨',
      'ã§ããŸ! ã™ã”ã„ã‚ˆ! ğŸŒŸ',
      'ã‚ˆããŒã‚“ã°ã£ãŸ! ãˆã‚‰ã„! ğŸ‘',
      'ãƒŠã‚¤ã‚¹! æœ€é«˜ã ã‚ˆ! ğŸµ',
      'ã‚¯ãƒªã‚¢ãƒ¼! ã™ã°ã‚‰ã—ã„! ğŸ¨',
      'ãŒã‚“ã°ã£ã¦ã‚‹ã­! ã‚¹ãƒ†ã‚­! ğŸ’–',
      'ã‚„ã‚‹ã˜ã‚ƒã‚“! ã‹ã£ã“ã„ã„! ğŸ˜',
      'ã»ã‚“ã¨ã™ã”ã„! ğŸŒˆ',
      'ã§ãã¡ã‚ƒã†ã‚“ã ! ã™ã”ã„! â­',
      'ã‚ˆã—! ã§ããŸã­! ğŸ¯',
      'ãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸ! ğŸ…',
      'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ! ğŸ’¯',
      'ã™ã”ã„ããƒ¼! ğŸª',
      'ã‚„ã‚Œã°ã§ãã‚‹! ãˆã‚‰ã„! ğŸŒº'
    ];

    // å®Œäº†æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const completeMessages = {
      all: [
        'å…¨éƒ¨ã§ããŸã­! æœ¬å½“ã«ã™ã”ã„! ğŸ‰',
        'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ! ãŒã‚“ã°ã£ãŸã­! âœ¨',
        'å…¨ã‚¯ãƒªã‚¢! ã‹ã£ã“ã„ã„! ğŸ’ª'
      ],
      some: [
        'ä»Šæ—¥ã¯ã“ã“ã¾ã§! ã‚ˆããŒã‚“ã°ã£ãŸã­! ğŸ˜Š',
        'ãŠã¤ã‹ã‚Œã•ã¾! ã§ããŸã“ã¨ã‚’ ã»ã“ã£ã¦ã­! ğŸŒŸ',
        'ã“ã“ã¾ã§ã§ããŸã®ãŒ ã™ã”ã„ã‚ˆ! âœ¨'
      ]
    };

    // å†™çœŸç®¡ç†
    let rewardPhotos = [];

    // çŠ¶æ…‹ã®ä¿å­˜
    function saveState() {
      const state = {
        currentMissions: currentMissions,
        completedCount: completedCount,
        isInProgress: true,
        screen: 'challenge'
      };
      localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(state));
    }

    // çŠ¶æ…‹ã®å¾©å…ƒ
    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY_STATE);
      if (saved) {
        try {
          const state = JSON.parse(saved);
          if (state.isInProgress && state.currentMissions && state.currentMissions.length > 0) {
            currentMissions = state.currentMissions;
            completedCount = state.completedCount || 0;
            return state.screen || 'challenge';
          }
        } catch (e) {
          console.error('çŠ¶æ…‹ã®å¾©å…ƒã«å¤±æ•—:', e);
        }
      }
      return null;
    }

    // çŠ¶æ…‹ã®ã‚¯ãƒªã‚¢
    function clearState() {
      localStorage.removeItem(STORAGE_KEY_STATE);
    }

    // å†™çœŸã®èª­ã¿è¾¼ã¿
    function loadPhotos() {
      const saved = localStorage.getItem(STORAGE_KEY_PHOTOS);
      if (saved) {
        try {
          rewardPhotos = JSON.parse(saved);
        } catch (e) {
          console.error('å†™çœŸã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
          rewardPhotos = [];
        }
      }
    }

    // å†™çœŸã®ä¿å­˜
    function savePhotos() {
      try {
        localStorage.setItem(STORAGE_KEY_PHOTOS, JSON.stringify(rewardPhotos));
      } catch (e) {
        console.error('å†™çœŸã®ä¿å­˜ã«å¤±æ•—:', e);
        alert('å†™çœŸãŒå¤šã™ãã¾ã™ã€‚ã„ãã¤ã‹å‰Šé™¤ã—ã¦ãã ã•ã„');
      }
    }

    // å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆè‡ªå‹•ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ä»˜ãï¼‰
    function handlePhotoUpload(event) {
      const files = event.target.files;
      
      if (files.length === 0) return;

      Array.from(files).forEach(file => {
        if (!file.type.startsWith('image/')) {
          return;
        }

        // ç”»åƒã‚’è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã—ã¦ä¿å­˜
        resizeImage(file, (resizedDataUrl) => {
          rewardPhotos.push({
            id: Date.now() + Math.random(),
            data: resizedDataUrl
          });
          savePhotos();
          renderPhotoGrid();
        });
      });

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
      event.target.value = '';
    }

    // ç”»åƒãƒªã‚µã‚¤ã‚ºé–¢æ•°ï¼ˆæœ€å¤§800pxã€å“è³ª0.8ï¼‰
    function resizeImage(file, callback) {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const img = new Image();
        
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          
          // æœ€å¤§ã‚µã‚¤ã‚ºè¨­å®š
          const MAX_WIDTH = 800;
          const MAX_HEIGHT = 800;
          
          let width = img.width;
          let height = img.height;
          
          // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ã¦ãƒªã‚µã‚¤ã‚º
          if (width > height) {
            if (width > MAX_WIDTH) {
              height = Math.round((height * MAX_WIDTH) / width);
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width = Math.round((width * MAX_HEIGHT) / height);
              height = MAX_HEIGHT;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          
          // ç”»åƒã‚’æç”»
          ctx.drawImage(img, 0, 0, width, height);
          
          // ãƒªã‚µã‚¤ã‚ºå¾Œã®ãƒ‡ãƒ¼ã‚¿URLã‚’å–å¾—ï¼ˆJPEGã€å“è³ª80%ï¼‰
          const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
          
          callback(resizedDataUrl);
        };
        
        img.src = e.target.result;
      };
      
      reader.readAsDataURL(file);
    }

    // å†™çœŸã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
    function renderPhotoGrid() {
      const grid = document.getElementById('photoGrid');
      const noPhotos = document.getElementById('noPhotos');
      
      if (rewardPhotos.length === 0) {
        grid.style.display = 'none';
        noPhotos.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      noPhotos.style.display = 'none';
      grid.innerHTML = '';

      rewardPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'photo-item';
        
        const img = document.createElement('img');
        img.src = photo.data;
        img.alt = `å†™çœŸ ${index + 1}`;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'photo-delete-btn';
        deleteBtn.textContent = 'âœ•';
        deleteBtn.onclick = () => deletePhoto(photo.id);
        
        item.appendChild(img);
        item.appendChild(deleteBtn);
        grid.appendChild(item);
      });
    }

    // å†™çœŸå‰Šé™¤
    function deletePhoto(photoId) {
      const confirmed = confirm('ã“ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹?');
      if (confirmed) {
        rewardPhotos = rewardPhotos.filter(p => p.id !== photoId);
        savePhotos();
        renderPhotoGrid();
      }
    }

    // ãƒ©ãƒ³ãƒ€ãƒ ãªå†™çœŸã‚’å–å¾—
    function getRandomPhoto() {
      if (rewardPhotos.length === 0) return null;
      const randomIndex = Math.floor(Math.random() * rewardPhotos.length);
      return rewardPhotos[randomIndex];
    }

    // ã”è¤’ç¾å†™çœŸã‚’è¡¨ç¤º
    function showRewardPhoto() {
      const photo = getRandomPhoto();
      const container = document.getElementById('rewardPhotoContainer');
      const img = document.getElementById('rewardPhoto');

      if (photo) {
        img.src = photo.data;
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // åˆæœŸåŒ–
    window.onload = function() {
      loadHistory();
      loadPhotos();
      initializeMissions();
      renderPhotoGrid();
      
      // ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ãŒã‚ã‚Œã°å¾©å…ƒ
      const savedScreen = loadState();
      if (savedScreen) {
        showScreen(savedScreen);
        renderMissions();
        updateProgress();
      } else {
        showScreen('setup');
      }
    };

    // ä¸€æ‹¬ãƒšãƒ¼ã‚¹ãƒˆå‡¦ç†ï¼ˆã‚¹ãƒãƒ›ã‚³ãƒ”ãƒ¼å¯¾å¿œå¼·åŒ–ç‰ˆï¼‰
    function parseBulkPaste() {
      const textarea = document.getElementById('bulkPasteArea');
      const text = textarea.value.trim();
      
      if (!text) {
        alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒšãƒ¼ã‚¹ãƒˆã—ã¦ãã ã•ã„');
        return;
      }
      
      let lines = [];
      
      // ã‚¹ãƒ†ãƒƒãƒ—1: ã¾ãšã‚¹ãƒ©ãƒƒã‚·ãƒ¥(/)ã§åˆ†å‰²ï¼ˆæœ€å„ªå…ˆï¼‰
      // Geminiã®å‡ºåŠ›ãŒã€ŒA / B / Cã€å½¢å¼ã®å ´åˆã«å¯¾å¿œ
      if (text.includes('/')) {
        const parts = text.split('/');
        parts.forEach(part => {
          const trimmed = part.trim();
          if (trimmed.length > 0) {
            lines.push(trimmed);
          }
        });
      } else {
        // ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ãŒãªã„å ´åˆã¯æ”¹è¡Œã§åˆ†å‰²
        const linesByNewline = text.split('\n');
        
        linesByNewline.forEach(line => {
          // ã‚«ãƒ³ãƒ(ã€,)ã§åˆ†å‰²
          const linesByComma = line.split(/[ã€,]/);
          
          linesByComma.forEach(item => {
            const trimmed = item.trim();
            if (trimmed.length > 0) {
              lines.push(trimmed);
            }
          });
        });
      }
      
      // ç•ªå·ã‚„è¨˜å·ã‚’å‰Šé™¤ï¼ˆä¾‹: 1. ã‚„ - ã‚„ â€¢ ãªã©ï¼‰
      lines = lines.map(line => {
        // è¡Œé ­ã®ç•ªå·ãƒ»è¨˜å·ãƒ»ç©ºç™½ã‚’å‰Šé™¤
        return line.replace(/^[\d\-\*\â€¢\.ã€‚\s]+/, '').trim();
      });
      
      // ç©ºè¡Œã‚’é™¤å¤–
      lines = lines.filter(line => line.length > 0);
      
      // é‡è¤‡ã‚’é™¤å»ï¼ˆå¿µã®ãŸã‚ï¼‰
      lines = [...new Set(lines)];
      
      if (lines.length === 0) {
        alert('æœ‰åŠ¹ãªãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      
      // æ—¢å­˜ã®å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
      const container = document.getElementById('missionInputs');
      container.innerHTML = '';
      
      // å„è¡Œã‚’ãƒŸãƒƒã‚·ãƒ§ãƒ³å…¥åŠ›æ¬„ã¨ã—ã¦è¿½åŠ 
      lines.forEach((line, index) => {
        addMissionInput(line);
      });
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      textarea.value = '';
      
      alert(`${lines.length}å€‹ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’è¿½åŠ ã—ã¾ã—ãŸ ğŸ‰`);
    }

    // åˆæœŸãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®šï¼ˆ8ã¤ã«å¤‰æ›´ï¼‰
    function initializeMissions() {
      const defaultMissions = [
        'ãã¤ã—ãŸã‚’ ã¯ã',
        'ãã¤ã‚’ ã¯ã',
        'ã’ã‚“ã‹ã‚“ã® ãƒ‰ã‚¢ã‚’ ã‚ã‘ã‚‹',
        'ãã¨ã« ã§ã‚‹',
        'ãã‚‹ã¾ã« ã®ã‚‹',
        'ã‚·ãƒ¼ãƒˆãƒ™ãƒ«ãƒˆã‚’ ã™ã‚‹',
        'ãŠã‚“ãŒãã‚’ ãã',
        'ãã‚‹ã¾ã‹ã‚‰ ãŠã‚Šã‚‹'
      ];
      
      const container = document.getElementById('missionInputs');
      container.innerHTML = '';
      
      defaultMissions.forEach((mission, index) => {
        addMissionInput(mission);
      });
    }

    // ãƒŸãƒƒã‚·ãƒ§ãƒ³å…¥åŠ›æ¬„è¿½åŠ 
    function addMissionInput(defaultValue = '') {
      const container = document.getElementById('missionInputs');
      const index = container.children.length;
      
      const div = document.createElement('div');
      div.className = 'mission-input';
      div.innerHTML = `
        <input type="text" 
               placeholder="ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ${index + 1}" 
               value="${defaultValue}"
               id="mission${index}">
        <button class="delete-btn" onclick="removeMissionInput(this)">âœ•</button>
      `;
      
      container.appendChild(div);
    }

    // ãƒŸãƒƒã‚·ãƒ§ãƒ³å…¥åŠ›æ¬„å‰Šé™¤
    function removeMissionInput(button) {
      const container = document.getElementById('missionInputs');
      if (container.children.length > 1) {
        button.parentElement.remove();
      } else {
        alert('æœ€ä½1ã¤ã¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå¿…è¦ã§ã™');
      }
    }

    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹
    function startChallenge() {
      const container = document.getElementById('missionInputs');
      missions = [];
      
      for (let i = 0; i < container.children.length; i++) {
        const input = document.getElementById(`mission${i}`);
        if (input && input.value.trim()) {
          missions.push({
            text: input.value.trim(),
            completed: false
          });
        }
      }
      
      if (missions.length === 0) {
        alert('ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      currentMissions = JSON.parse(JSON.stringify(missions));
      completedCount = 0;
      
      saveState();
      showScreen('challenge');
      renderMissions();
      updateProgress();
    }

    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Ÿè¡Œä¸­ã«ãƒŸãƒƒã‚·ãƒ§ãƒ³è¿½åŠ 
    function addMissionDuringChallenge() {
      const input = document.getElementById('newMissionInput');
      const newMissionText = input.value.trim();
      
      if (!newMissionText) {
        alert('ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã® å†…å®¹ã‚’ å…¥åŠ›ã—ã¦ãã ã•ã„!');
        return;
      }
      
      currentMissions.push({
        text: newMissionText,
        completed: false
      });
      
      input.value = '';
      renderMissions();
      updateProgress();
      saveState();
      
      alert('ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ ã¤ã„ã‹ã—ãŸã‚ˆ! ãŒã‚“ã°ã‚ã†! ğŸ’ª');
    }

    // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤º
    function renderMissions() {
      const list = document.getElementById('missionsList');
      list.innerHTML = '';
      
      currentMissions.forEach((mission, index) => {
        const item = document.createElement('div');
        item.className = 'mission-item' + (mission.completed ? ' completed' : '');
        item.onclick = () => toggleMission(index);
        
        item.innerHTML = `
          <div class="mission-checkbox">
            ${mission.completed ? 'âœ“' : ''}
          </div>
          <div class="mission-text">${mission.text}</div>
        `;
        
        list.appendChild(item);
      });
    }

    // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒˆã‚°ãƒ«
    function toggleMission(index) {
      const mission = currentMissions[index];
      
      if (!mission.completed) {
        mission.completed = true;
        completedCount++;
        
        const message = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
        alert(message);
        
        renderMissions();
        updateProgress();
        saveState();
      }
    }

    // é€²æ—æ›´æ–°
    function updateProgress() {
      const total = currentMissions.length;
      const percentage = Math.round((completedCount / total) * 100);
      
      document.getElementById('progressText').textContent = `${completedCount} / ${total}`;
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressBar').textContent = percentage + '%';
      
      const character = document.getElementById('challengeCharacter');
      if (completedCount === 0) {
        character.textContent = 'ğŸ˜¸';
      } else if (completedCount < total) {
        character.textContent = 'ğŸ’ª';
      } else {
        character.textContent = 'ğŸ‰';
      }
    }

    // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº†
    function finishChallenge() {
      const total = currentMissions.length;
      const isAllCompleted = completedCount === total;
      
      saveHistory(completedCount, total);
      clearState();
      
      document.getElementById('completeTitle').textContent = 
        isAllCompleted ? 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ! ğŸ‰' : 'ãŠã¤ã‹ã‚Œã•ã¾! ğŸ˜Š';
      
      const messageList = isAllCompleted ? completeMessages.all : completeMessages.some;
      document.getElementById('completeMessage').textContent = 
        messageList[Math.floor(Math.random() * messageList.length)];
      
      document.getElementById('resultNumber').textContent = `${completedCount} / ${total}`;
      
      const praise = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
      document.getElementById('praiseMessage').textContent = praise;
      
      // ã”è¤’ç¾å†™çœŸã‚’è¡¨ç¤º
      showRewardPhoto();
      
      showScreen('complete');
    }

    // é€”ä¸­çµ‚äº†
    function stopChallenge() {
      const confirmed = confirm('ä»Šæ—¥ã¯ ã“ã“ã¾ã§ã« ã—ã¾ã™ã‹?\n\nâ€» ãŒã‚“ã°ã£ãŸ ã¶ã‚“ã¯ ãã‚ãã« ã®ã“ã‚Šã¾ã™!');
      if (confirmed) {
        finishChallenge();
      }
    }

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    function showScreen(screenName) {
      document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
      });
      
      const screens = {
        'setup': 'setupScreen',
        'challenge': 'challengeScreen',
        'complete': 'completeScreen',
        'history': 'historyScreen',
        'photos': 'photosScreen'
      };
      
      document.getElementById(screens[screenName]).classList.add('active');
      
      if (screenName === 'history') {
        renderHistory();
      } else if (screenName === 'photos') {
        renderPhotoGrid();
      }
    }

    // å±¥æ­´ä¿å­˜
    function saveHistory(completed, total) {
      const record = {
        date: new Date().toLocaleString('ja-JP'),
        completed: completed,
        total: total
      };
      
      history.unshift(record);
      if (history.length > 10) {
        history = history.slice(0, 10);
      }
      
      localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
    }

    // å±¥æ­´èª­ã¿è¾¼ã¿
    function loadHistory() {
      const saved = localStorage.getItem(STORAGE_KEY_HISTORY);
      if (saved) {
        history = JSON.parse(saved);
      }
    }

    // å±¥æ­´è¡¨ç¤º
    function renderHistory() {
      const list = document.getElementById('historyList');
      
      if (history.length === 0) {
        list.innerHTML = '<div class="no-history">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      list.innerHTML = '';
      history.forEach((record, index) => {
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <div class="history-content">
            <div class="history-date">${record.date}</div>
            <div class="history-stats">
              ${record.completed} / ${record.total} é”æˆ
              ${record.completed === record.total ? 'ğŸ‰' : 'ğŸ˜Š'}
            </div>
          </div>
          <button class="delete-history-btn" onclick="deleteHistory(${index})">âœ•</button>
        `;
        list.appendChild(item);
      });
    }

    // å±¥æ­´å‰Šé™¤
    function deleteHistory(index) {
      const confirmed = confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹?');
      if (confirmed) {
        history.splice(index, 1);
        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
        renderHistory();
      }
    }
  </script>
</body>
</html>
